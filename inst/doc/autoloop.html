<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Fast loops with offarrays</title>



<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Fast loops with offarrays</h1>



<p>The <code>offarray</code> package lets you work with arrays (and matrices and
vectors) whose indexing can start wherever you like— not just at 1 as
in base-R, nor just at 0 as in misbegotten languages like C. This is
great for applications like population dynamics: you can start your
years at 2015, you can start your range of ages at 8, etc. Simpler,
clearer, less buggity-bug-bug.</p>
<p>Most R-ish things work as you would expect on <code>offarray</code> objects. There
is documentation! Try <code>?offarray</code> (where exceptions are noted) and
<code>utils::example(’offarray’,’offarray’)</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>( mvbutils)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>( offarray)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">options</span>( <span class="at">digits=</span><span class="dv">4</span>)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>bloop <span class="ot">&lt;-</span> <span class="fu">offarray</span>( <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="at">dimseq=</span><span class="fu">list</span>( <span class="dv">11</span><span class="sc">:</span><span class="dv">12</span>, <span class="dv">21</span><span class="sc">:</span><span class="dv">23</span>))</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>bloop <span class="sc">+</span> <span class="dv">3</span></span></code></pre></div>
<pre><code>##       [,21] [,22] [,23]
## [11,]     4     6     8
## [12,]     5     7     9</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>bloop <span class="sc">&gt;</span> <span class="dv">0</span></span></code></pre></div>
<pre><code>##       [,21] [,22] [,23]
## [11,]  TRUE  TRUE  TRUE
## [12,]  TRUE  TRUE  TRUE</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>bloop[<span class="dv">11</span>,]</span></code></pre></div>
<pre><code>##       [,21] [,22] [,23]
## [11,]     1     3     5</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>bloop[SLICE<span class="ot">=</span><span class="dv">11</span>,] <span class="co"># drops the dimension (drop is off by default)</span></span></code></pre></div>
<pre><code>## [21] [22] [23] 
##    1    3    5</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="do">## utils::example( &#39;offarray&#39;, &#39;offarray&#39;)...</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="do">## ... or even try reading the documentation of &#39;?offarray&#39;...</span></span></code></pre></div>
<p>You can also use <code>offarray</code> with Kasper Kristensen’s stupendous<code>RTMB</code>
package— so you can get first derivatives in high-dimensional problems
really fast, and fit complicated statistical models with remarkable
ease. (Of course, the whole point of <code>RTMB</code> is that you can use regular
R code. But it took some work to get <code>offarray</code> working with it.) <strong>This
is amazing!!!</strong></p>
<div id="package-tmbo" class="section level2">
<h2>Package <code>TMBO</code></h2>
<p>Note that you can also use <code>offarray</code> with my package <code>TMBO</code>, which
deliberately lets you write flexible-offset TMB code (in C++, of course;
that’s good old TMB, not <code>RTMB</code>) that is fully <code>offarray</code>-compatible on
the R side. In marked contrast to native TMB, TMBO also gives very
informative non-crashy error messages when you go Out-Of-Bounds (OOB) or
commit other array-access stuff-ups, which are by far the commonest
problem. However, I suspect that TMBO — which was a lot of work to
write in late 2023, and which I’m kinda proud of— will be obsolete
almost immediately, because <code>RTMB</code> and <code>offarray</code> will just remove the
need ever to go near C++ again. And I will shed no tears whatsoever if
that is the case.</p>
</div>
<div id="loops-and-speed" class="section level1">
<h1>Loops and speed</h1>
<p>When you need to to fill in an offarray one-element-at-a-time, for-loops
are going to be slow, especially nested ones. A staggering amount of
argument-checking gets done behind the scenes in R <em>every time</em> a single
offarray element is read; and every time one element is changed, R makes
a deep copy<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> of the entire offarray, which gets very costly for big
offarrays. Even if you only intend to run your R code once for
<code>RTMB::MakeADFun</code>, normal for-loops can <em>still</em> be waaaaay too slow.
However, you can <em>completely solve the problem</em> by using <code>autoloop()</code> to
do (almost) all the loops for you, with <em>minimal</em> cost in comprehension.
Cost in simple cases is about 2-3 times slower than base-R, ie
negligible penalty. Here’s an example:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">20</span> <span class="co"># array has 8000 elements (smallish)</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>  xR <span class="ot">&lt;-</span> <span class="fu">array</span>( <span class="dv">0</span>, <span class="fu">rep</span>( N, <span class="dv">3</span>));</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>  <span class="cf">for</span>( i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) <span class="cf">for</span>( j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) <span class="cf">for</span>( k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) </span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>    xR[ i,j,k] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(i<span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>j<span class="sc">+</span><span class="dv">3</span><span class="sc">*</span>k)</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>##    user  system elapsed 
##       0       0       0</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>  xO <span class="ot">&lt;-</span> <span class="fu">offarray</span>(<span class="dv">0</span>, <span class="at">dimseq=</span><span class="fu">list</span>( <span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N));</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>  <span class="cf">for</span>( i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) <span class="cf">for</span>( j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) <span class="cf">for</span>( k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) </span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>    xO[ i,j,k] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(i<span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>j<span class="sc">+</span><span class="dv">3</span><span class="sc">*</span>k)</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>##    user  system elapsed 
##    0.16    0.08    0.39</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="fu">system.time</span>( </span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>  xA <span class="ot">&lt;-</span> <span class="fu">autoloop</span>( <span class="at">i=</span><span class="dv">1</span><span class="sc">:</span>N, <span class="at">j=</span><span class="dv">1</span><span class="sc">:</span>N, <span class="at">k=</span><span class="dv">1</span><span class="sc">:</span>N, </span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">/</span>(i<span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>j<span class="sc">+</span><span class="dv">3</span><span class="sc">*</span>k))</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##       0       0       0</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># try 400 for a real test; then 8e6 elements and 512 MB</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="fu">system.time</span>( </span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>  xA <span class="ot">&lt;-</span> <span class="fu">autoloop</span>( <span class="at">i=</span><span class="dv">1</span><span class="sc">:</span>N, <span class="at">j=</span><span class="dv">1</span><span class="sc">:</span>N, <span class="at">k=</span><span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">/</span>(i<span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>j<span class="sc">+</span><span class="dv">3</span><span class="sc">*</span>k))</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##    0.10    0.00    0.11</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="do">## Don&#39;t even TRY the direct loop over offarrays!!!</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>  xR <span class="ot">&lt;-</span> <span class="fu">array</span>( <span class="dv">0</span>, <span class="fu">rep</span>( N, <span class="dv">3</span>));</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>  <span class="cf">for</span>( i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) <span class="cf">for</span>( j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) <span class="cf">for</span>( k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) </span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>    xR[ i,j,k] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(i<span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>j<span class="sc">+</span><span class="dv">3</span><span class="sc">*</span>k)</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>##    user  system elapsed 
##    0.05    0.00    0.07</code></pre>
<p>Of course, sometimes you can’t entirely avoid for-loops. A classic
example is time-stepping thru population-dynamics calculations over the
years. That’s fine; by all means have a for-loop over years, but just
try to do all the work <em>within</em> each year via one-or-more <code>autoloop</code>
calls.</p>
<p><code>autoloop</code>will also do automatic contractions for you, i.e.
accumulating a sum over an index which does not appear in the result.
Matrix-multiplication is the most obvious example. Of course, you would
not normally use <code>autoloop</code> just for that, but here’s how you could.
Notice also that <code>autoloop</code> can use base-R arrays as well as offarrays :</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>mm <span class="ot">&lt;-</span> <span class="fu">matrix</span>( <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>xx <span class="ot">&lt;-</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">6</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>mx <span class="ot">&lt;-</span> <span class="fu">autoloop</span>( <span class="at">i=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">SUMOVER=</span><span class="fu">list</span>( <span class="at">j=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>),</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>  mm[i,j] <span class="sc">*</span> xx[ j]</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>)</span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>mx</span></code></pre></div>
<pre><code>## i
## [1] [2] 
##  49  64</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>mm <span class="sc">%*%</span> xx</span></code></pre></div>
<pre><code>##      [,1]
## [1,]   49
## [2,]   64</code></pre>
<p>Automatic contraction comes into its own with probability calculations
in population dynamics, and especially in close-kin mark-recapture, when
you might be dealing with a 7-dimensional set of indices that you want
to sum down to just 5; good luck concocting a base-R expression for
that!</p>
<p>You can have several statements within the body of an <code>autoloop</code>,
wrapped inside {} and separated by semicolons. Some statements might
compute ephemeral quantities that are needed only for computing other
things, and that don’t need to be kept afterwards. Other statements can
produce named variables that you do keep at the end. The examples later
on show all that.</p>
<div id="how-does-autoloop-work" class="section level2">
<h2>How does <code>autoloop</code> work?</h2>
<p><code>?autoloop</code></p>
<p>If that’s too much effort to read: <code>autoloop</code> is like base-R <code>outer</code>,
but generalized and betterized. Which should encourage you to read
<code>?autoloop</code>...</p>
</div>
</div>
<div id="programming-styles-with-autoloop" class="section level1">
<h1>Programming styles with <code>autoloop</code></h1>
<p><code>autoloop</code> auto-vectorizes your expression, and then evaluates it over
subsets of a few thousand index-combinations at a time. Therefore, what
it runs is not <em>quite</em> what you wrote, but if you stick to simple rules
then you will never see the difference— and if you don’t, it probably
won’t run at all. Basically, every statement within your <code>autoloop</code>
expression should result in a vector of the same length. Even though
array-accesses don’t <em>look</em> like they will do that, the magic of
<code>autoloop</code> ensures that they generally do<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>.</p>
<p>Mathematical operations within an <code>autoloop</code> expression generally work
fine (though not matrix-multiply— but that is simple to code manually
within the expression). The main limitation is that you can’t use
<code>if</code>-statements<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a> The R function <code>ifelse()</code> can accomplish the same
thing, but be aware that <code>ifelse(cond,ex1,ex2)</code> always evaluates <em>both</em>
<code>ex1</code> and <code>ex2</code> whether <code>cond</code> is TRUE or FALSE. That can lead to OOB
trouble if you naively try to access arrays, which is usually what I use
<code>autoloop</code> for. I’d like to put in a general Bayes-theorem example here,
but I’d have to think about it, and who’s got time for that? So instead,
here’s a no-thought example from Close-Kin Mark-Recapture. If you are
currently or imminently doing the CKMR workshop, maybe defer reading
this until Day 2! If not, you might not understand the background at
all— never mind :)</p>
<p>For a range of adult sampling years Y and ages-at-sampling A, and
juvenile birth-years B, we consider a comparison between a potential
parent adult and potential offspring juvenile. The adult is lethally
caught in year Ya at age Aa, and the juvenile in Yj at Aj. What is the
demographic probability that the two will be a Parent-Offspring Pair,
aka POP? In simple cases, that probability is just the adult’s expected
fecundity in the birth-year Bj (which will depend on the adult’s age at
Bj, plus whether the adult would actually be alive then), divided by the
total fecundity across <em>all</em> adults in year B, which I’ve pre-calculated
for simplicity. Let’s make all this sex-specific while we’re at it,
because you always <em>should</em> in CKMR. And we’ll use <code>autoloop</code>. Here’s a
naive example, showing off multi-statement code while we’re again at it:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>  SEXES <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="st">&quot;Female&quot;</span>, <span class="st">&quot;Male&quot;</span>)</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>  adSAMPYEARS <span class="ot">&lt;-</span> <span class="dv">1995</span><span class="sc">:</span><span class="dv">2000</span>    <span class="co"># when our &quot;adults&quot; were sampled</span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>  adAGES <span class="ot">&lt;-</span> <span class="dv">6</span><span class="sc">:</span><span class="dv">9</span>               <span class="co"># ... of adults (ie potential parents)</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>  juSAMPYEARS <span class="ot">&lt;-</span> <span class="dv">1990</span><span class="sc">:</span><span class="dv">1999</span>    <span class="co"># when our potential offspring were sampled</span></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>  juAGES <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>               <span class="co"># ... and their range of ages at sampling</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>  juBYEARS <span class="ot">&lt;-</span> (<span class="dv">1990-3</span>)<span class="sc">:</span>(<span class="dv">1999-1</span>)  <span class="co"># implied range of juvenile birth-years</span></span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a>  <span class="co"># Any old values for fecundity-at-age...</span></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a>  fec_SA <span class="ot">&lt;-</span> <span class="fu">autoloop</span>( <span class="at">S=</span>SEXES, <span class="at">A=</span>adAGES, <span class="fu">log</span>( A))</span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a>  </span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a>  <span class="co"># Any old values for total fecundity over the years... say from 1e6 typical age-7 adults</span></span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a>  totfec_SB <span class="ot">&lt;-</span> <span class="fu">autoloop</span>( <span class="at">S=</span>SEXES, <span class="at">B=</span>juBYEARS, <span class="fl">1e6</span> <span class="sc">*</span> fec_SA[ S, <span class="dv">7</span>])</span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a>  <span class="fu">try</span>( Pr_POP_SYAYA <span class="ot">&lt;-</span> <span class="fu">autoloop</span>( </span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a>      <span class="at">Sa=</span>SEXES, <span class="at">Ya=</span>adSAMPYEARS, <span class="at">Aa=</span>adAGES, </span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a>      <span class="at">Yj=</span>juSAMPYEARS, <span class="at">Aj=</span>juAGES, {  <span class="co"># curly required coz multiple statements</span></span>
<span id="cb24-17"><a href="#cb24-17" tabindex="-1"></a>    Bj <span class="ot">&lt;-</span> Yj <span class="sc">-</span> Aj;                  <span class="co"># birth of Our juvenile</span></span>
<span id="cb24-18"><a href="#cb24-18" tabindex="-1"></a>    Aa_at_Bj <span class="ot">&lt;-</span> Aa <span class="sc">-</span> (Ya <span class="sc">-</span> Bj);     <span class="co"># how old was Our adult then?</span></span>
<span id="cb24-19"><a href="#cb24-19" tabindex="-1"></a>    Pr <span class="ot">&lt;-</span> <span class="fu">ifelse</span>( Ya <span class="sc">&gt;=</span> Bj,         <span class="co"># was adult still alive then?</span></span>
<span id="cb24-20"><a href="#cb24-20" tabindex="-1"></a>      fec_SA[ Sa, Aa_at_Bj] <span class="sc">/</span> totfec_SB[ Sa, Bj],  <span class="co"># yes: competing against other adults</span></span>
<span id="cb24-21"><a href="#cb24-21" tabindex="-1"></a>      <span class="dv">0</span>)                            <span class="co"># no: dead already</span></span>
<span id="cb24-22"><a href="#cb24-22" tabindex="-1"></a>    <span class="fu">return</span>( Pr)</span>
<span id="cb24-23"><a href="#cb24-23" tabindex="-1"></a>   }))</span></code></pre></div>
<pre><code>## Error in autoloop(Sa = SEXES, Ya = adSAMPYEARS, Aa = adAGES, Yj = juSAMPYEARS,  : 
##   @Sa=&quot;Female&quot;, Ya=1995L, Aa=9L, Yj=1992L, Aj=1L@  index woe for fec_SA[Sa, Aa_at_Bj]</code></pre>
<p>Well, that didn’t work, but at least the error message gives you a
chance to figure out why. The problem is with accessing
<code>fec_SA``[``Sa,Aa_at_Bj``]</code> and clearly <code>Sa</code> won’t be the cause, so it
must be <code>Aa_at_Bj</code> . The error message doesn’t show you <code>Aa_at_Bj</code>
directly<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a>, because it’s calculated only within the expression, but we
can see where it came from. With <code>Ya=1995,Aa=9,Yj=1992,Aj=1</code> we would
have <code>Bj=1992-1=1991</code> and <code>Ya-Bj=1995-1991=4</code> and <code>Aa_at_Bj=9-4=5</code>. But
the range of adult ages, <code>adAGES</code>, which indexes <code>fec_SA</code>, is only 6:9.
So the real problem is that our adult wasn’t adult back then; s/he was
too young. (The calculation could even have led to a negative age for
the adult, if the juvenile was born before s/he was!) While we’re at it,
there is also the possibility of exceeding the maximum adult age— it
won’t be the case in the samples, because sampling kills the adults, but
if we compare an adult to a juvenile born <em>after</em> the adult capture,
then er <em>projected</em> age could be OOB. Let’s fix that quickly:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>  <span class="fu">try</span>( Pr_POP_SYAYA <span class="ot">&lt;-</span> <span class="fu">autoloop</span>( </span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>      <span class="at">Sa=</span>SEXES, <span class="at">Ya=</span>adSAMPYEARS, <span class="at">Aa=</span>adAGES, </span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>      <span class="at">Yj=</span>juSAMPYEARS, <span class="at">Aj=</span>juAGES, {</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>    Bj <span class="ot">&lt;-</span> Yj <span class="sc">-</span> Aj;                  <span class="co"># birth of Our juvenile</span></span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>    Aa_at_Bj <span class="ot">&lt;-</span> Aa <span class="sc">-</span> (Ya <span class="sc">-</span> Bj);     <span class="co"># how old was Our adult then?</span></span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a>    Pr <span class="ot">&lt;-</span> <span class="fu">ifelse</span>( </span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>        (Ya <span class="sc">&gt;=</span> Bj) <span class="sc">&amp;</span>                   <span class="co"># too dead; note single ampersand coz vector</span></span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>        (Aa_at_Bj <span class="sc">&gt;=</span> <span class="fu">min</span>( adAGES)) <span class="sc">&amp;</span>   <span class="co"># too young</span></span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a>        (Aa_at_Bj <span class="sc">&lt;=</span> <span class="fu">max</span>( adAGES)),    <span class="co"># too old in future (and will actually be already dead!)</span></span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a>      fec_SA[ Sa, Aa_at_Bj] <span class="sc">/</span> totfec_SB[ Sa, Bj],  <span class="co"># yes: competing</span></span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a>      <span class="dv">0</span>)                             <span class="co"># no: not around</span></span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a>    <span class="fu">return</span>( Pr)</span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a>   }))</span></code></pre></div>
<pre><code>## Error in autoloop(Sa = SEXES, Ya = adSAMPYEARS, Aa = adAGES, Yj = juSAMPYEARS,  : 
##   @Sa=&quot;Female&quot;, Ya=1995L, Aa=9L, Yj=1992L, Aj=1L@  index woe for fec_SA[Sa, Aa_at_Bj]</code></pre>
<p>Same goddamn problem. The logic is fine now, but the problem is that
<code>ifelse</code> still evaluates both the yes and no cases every time. So what
we have to do, is to fix up the array access to <em>never</em> OOB, by tweaking
the index; the <code>ifelse(...,0)</code> will give the right answer overall in
such cases anyway, and we won’t offend the OOB gods. There are many ways
to code that, but the easiest is perhaps to pipe thru the
<code>mvbutils::clamp</code> function, which restricts its input to a range:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>  <span class="co"># No try() needed this time!</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>  Pr_POP_SYAYA <span class="ot">&lt;-</span> <span class="fu">autoloop</span>( </span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>      <span class="at">Sa=</span>SEXES, <span class="at">Ya=</span>adSAMPYEARS, <span class="at">Aa=</span>adAGES, </span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>      <span class="at">Yj=</span>juSAMPYEARS, <span class="at">Aj=</span>juAGES, {</span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>    Bj <span class="ot">&lt;-</span> Yj <span class="sc">-</span> Aj;                  <span class="co"># birth of Our juvenile</span></span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>    Aa_at_Bj <span class="ot">&lt;-</span> Aa <span class="sc">-</span> (Ya <span class="sc">-</span> Bj);     <span class="co"># how old was Our adult then?</span></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>    Pr <span class="ot">&lt;-</span> <span class="fu">ifelse</span>( </span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a>        (Ya <span class="sc">&gt;=</span> Bj) <span class="sc">&amp;</span>                  <span class="co"># too dead</span></span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a>        (Aa_at_Bj <span class="sc">&gt;=</span> <span class="fu">min</span>( adAGES)) <span class="sc">&amp;</span>  <span class="co"># too young</span></span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a>        (Aa_at_Bj <span class="sc">&lt;=</span> <span class="fu">max</span>( adAGES)),   <span class="co"># too old</span></span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a>      fec_SA[ Sa, Aa_at_Bj <span class="sc">|&gt;</span> <span class="fu">clamp</span>( adAGES)] <span class="sc">/</span></span>
<span id="cb28-12"><a href="#cb28-12" tabindex="-1"></a>        totfec_SB[ Sa, Bj],          <span class="co"># yes, competing</span></span>
<span id="cb28-13"><a href="#cb28-13" tabindex="-1"></a>      <span class="dv">0</span>)                             <span class="co"># not around</span></span>
<span id="cb28-14"><a href="#cb28-14" tabindex="-1"></a>    <span class="fu">return</span>( Pr)</span>
<span id="cb28-15"><a href="#cb28-15" tabindex="-1"></a>   })</span></code></pre></div>
<p>Over time, I have come to feel that <code>ifelse</code> offers little by way of
clarity and speed in contexts like this. Instead, I take advantage of
multiplication by 0 and R’s automatic type-casting of logicals to
numerics, like so:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a>  Pr_POP_SYAYA <span class="ot">&lt;-</span> <span class="fu">autoloop</span>( </span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>      <span class="at">Sa=</span>SEXES, <span class="at">Ya=</span>adSAMPYEARS, <span class="at">Aa=</span>adAGES, </span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>      <span class="at">Yj=</span>juSAMPYEARS, <span class="at">Aj=</span>juAGES, {</span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a>    Bj <span class="ot">&lt;-</span> Yj <span class="sc">-</span> Aj;                  <span class="co"># birth of Our juvenile</span></span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a>    Aa_at_Bj <span class="ot">&lt;-</span> Aa <span class="sc">-</span> (Ya <span class="sc">-</span> Bj);     <span class="co"># how old was Our adult then?</span></span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a>    Pr <span class="ot">&lt;-</span></span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a>      (Ya <span class="sc">&gt;=</span> Bj) <span class="sc">*</span>                   <span class="co"># if FALSE, entire expression will give 0</span></span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a>      (Aa_at_Bj <span class="sc">&gt;=</span> <span class="fu">min</span>( adAGES)) <span class="sc">*</span>   <span class="co"># ditto</span></span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a>      (Aa_at_Bj <span class="sc">&lt;=</span> <span class="fu">max</span>( adAGES)) <span class="sc">*</span>   <span class="co"># ditto</span></span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a>      fec_SA[ Sa, Aa_at_Bj <span class="sc">|&gt;</span> <span class="fu">clamp</span>( adAGES)] <span class="sc">/</span></span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a>        totfec_SB[ Sa, Bj]  </span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a>    <span class="fu">return</span>( Pr)</span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a>   })</span></code></pre></div>
<p>Lovely! And while I’m still at it, I’ll illustrate another <code>autoloop</code>
feature. First, you can return multiple arguments— they will each be
an <code>offarray</code> with the same dimensions, and they’ll will be put together
into a named list. Second, you can use <code>mvbutils::extract.named</code> to
immediately turn those list elements into actual variables, in the place
where you do the call. The demonstration will compute the expected
number of kin-pairs by covariate category, based on the relevant numbers
of samples:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>  <span class="co"># Make up some sample sizes...</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>  nsamp_ad_SYA <span class="ot">&lt;-</span> <span class="fu">autoloop</span>( <span class="at">S=</span>SEXES, <span class="at">Y=</span>adSAMPYEARS, <span class="at">A=</span>adAGES, </span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a>      <span class="dv">10</span> <span class="sc">*</span> <span class="fu">sqrt</span>( A) <span class="sc">*</span> <span class="fu">log</span>( Y))</span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>  nsamp_ju_YA <span class="ot">&lt;-</span> <span class="fu">autoloop</span>( <span class="at">Y=</span>juSAMPYEARS, <span class="at">A=</span>juAGES, </span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a>      <span class="dv">5</span> <span class="sc">*</span> <span class="fu">sqrt</span>( A<span class="sc">+</span>Y) <span class="sc">*</span> <span class="fu">log</span>( Y<span class="sc">-</span>A))</span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a>  <span class="fu">extract.named</span>( <span class="fu">autoloop</span>( </span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a>      <span class="at">Sa=</span>SEXES, <span class="at">Ya=</span>adSAMPYEARS, <span class="at">Aa=</span>adAGES, </span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a>      <span class="at">Yj=</span>juSAMPYEARS, <span class="at">Aj=</span>juAGES, {</span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a>    Bj <span class="ot">&lt;-</span> Yj <span class="sc">-</span> Aj;                  <span class="co"># birth of Our juvenile</span></span>
<span id="cb30-11"><a href="#cb30-11" tabindex="-1"></a>    Aa_at_Bj <span class="ot">&lt;-</span> Aa <span class="sc">-</span> (Ya <span class="sc">-</span> Bj);     <span class="co"># how old was Our adult then?</span></span>
<span id="cb30-12"><a href="#cb30-12" tabindex="-1"></a>    Pr_POP_SYAYA <span class="ot">&lt;-</span> </span>
<span id="cb30-13"><a href="#cb30-13" tabindex="-1"></a>        (Ya <span class="sc">&gt;=</span> Bj) <span class="sc">*</span>                   <span class="co"># if FALSE, entire expression will give 0</span></span>
<span id="cb30-14"><a href="#cb30-14" tabindex="-1"></a>        (Aa_at_Bj <span class="sc">&gt;=</span> <span class="fu">min</span>( adAGES)) <span class="sc">*</span>   <span class="co"># ditto</span></span>
<span id="cb30-15"><a href="#cb30-15" tabindex="-1"></a>        (Aa_at_Bj <span class="sc">&lt;=</span> <span class="fu">max</span>( adAGES)) <span class="sc">*</span>   <span class="co"># ditto</span></span>
<span id="cb30-16"><a href="#cb30-16" tabindex="-1"></a>        fec_SA[ Sa, Aa_at_Bj <span class="sc">|&gt;</span> <span class="fu">clamp</span>( adAGES)] <span class="sc">/</span></span>
<span id="cb30-17"><a href="#cb30-17" tabindex="-1"></a>          totfec_SB[ Sa, Bj]  ;</span>
<span id="cb30-18"><a href="#cb30-18" tabindex="-1"></a>    E_POP_SYAYA <span class="ot">&lt;-</span> </span>
<span id="cb30-19"><a href="#cb30-19" tabindex="-1"></a>        Pr_POP_SYAYA <span class="sc">*</span></span>
<span id="cb30-20"><a href="#cb30-20" tabindex="-1"></a>        nsamp_ad_SYA[ Sa, Ya, Aa] <span class="sc">*</span></span>
<span id="cb30-21"><a href="#cb30-21" tabindex="-1"></a>        nsamp_ju_YA[ Yj, Aj]  ;</span>
<span id="cb30-22"><a href="#cb30-22" tabindex="-1"></a>    <span class="fu">returnList</span>( Pr_POP_SYAYA, E_POP_SYAYA)</span>
<span id="cb30-23"><a href="#cb30-23" tabindex="-1"></a>   }))</span>
<span id="cb30-24"><a href="#cb30-24" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" tabindex="-1"></a><span class="fu">ls</span>( <span class="at">patt=</span><span class="st">&#39;_POP_&#39;</span>) <span class="co"># both are there...</span></span></code></pre></div>
<pre><code>## [1] &quot;E_POP_SYAYA&quot;  &quot;Pr_POP_SYAYA&quot;</code></pre>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="fu">sum</span>( E_POP_SYAYA)</span></code></pre></div>
<pre><code>## [1] 86.35</code></pre>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a>E_POP_SYAYA[,<span class="dv">1999</span><span class="sc">:</span><span class="dv">2000</span>,<span class="dv">8</span>,<span class="dv">1998</span><span class="sc">:</span><span class="dv">1999</span>,<span class="dv">1</span>]</span></code></pre></div>
<pre><code>## , , Aa = 8, Yj = 1998, Aj = 1
## 
##         Ya
## Sa       [,1999] [,2000]
##   Female  0.3363       0
##   Male    0.3363       0
## 
## , , Aa = 8, Yj = 1999, Aj = 1
## 
##         Ya
## Sa       [,1999] [,2000]
##   Female  0.3653  0.3364
##   Male    0.3653  0.3364</code></pre>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="co"># Aggregate over adult sex, post hoc.</span></span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a><span class="co"># Works coz autoloop produces things with named dimensions.  </span></span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a><span class="fu">sumover</span>( E_POP_SYAYA[,<span class="dv">1999</span><span class="sc">:</span><span class="dv">2000</span>,<span class="dv">8</span>,<span class="dv">1998</span><span class="sc">:</span><span class="dv">1999</span>,<span class="dv">1</span>],    <span class="st">&#39;Sa&#39;</span>)</span></code></pre></div>
<pre><code>## , , Yj = 1998, Aj = 1
## 
##          Aa
## Ya          [,8]
##   [1999,] 0.6725
##   [2000,] 0.0000
## 
## , , Yj = 1999, Aj = 1
## 
##          Aa
## Ya          [,8]
##   [1999,] 0.7306
##   [2000,] 0.6728</code></pre>
</div>
<div id="with-package-rtmb" class="section level1">
<h1>With package <code>RTMB</code></h1>
<p>This isn’t the right place to document the <code>RTMB</code> link! There should be
a separate demo, probably in package <code>offartmb</code>. Anyway, the general
point is: you can write a function using <code>offarray</code> and <code>autoloop</code>, and
with minimal care you can evaluate it either directly in R, or via
<code>RTMB::MakeADFun</code>, which creates a C-level version of your function
<em>and</em> its derivative. That means it will run really fast, especially in
the context of fitting to data. Plus, <code>RTMB</code> can automatically do
Laplace approximation to integrate out random effects, etc etc. WOW!</p>
<p>What you need to do:</p>
<ul>
<li><p>Load the package <code>offartmb</code>, after<a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a> loading <code>offarray</code> and
<code>RTMB</code>.</p></li>
<li><p>Wrap the body of your objective function in a call to <code>reclasso</code>, as
shown below. This will have <em>no effect</em> if you are running the
function directly in R, but will also make it work nicely with
<code>RTMB::MakeADFun</code>. It won’t work if you don’t.</p></li>
<li><p>If you want to store variables calculated inside your objective
function, so they are available afterwards, name them in a call to
<code>REPORTO()</code> somewhere (like the C macro <code>REPORT()</code> in good old TMB).</p></li>
<li><p>Avoid comparison-operations in your code, eg ==, &gt;. RTMB hates
them. You might be able to get away with them if they only apply to
data, but in that case you are better off doing them beforehand and
storing the results as additional data objects.</p></li>
<li><p>Good practice is to put the data needed by your function into a
separate <code>environment</code>, and attach that environment to your
function. The things from <code>REPORTO()</code> will be stored there too. This
is a general principle well worth learning about in R— not
specific to <code>RTMB</code>, but perhaps particularly relevant there. The
CKMR course examples all do it.</p></li>
</ul>
<p>An example, but not one to run:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a><span class="cf">if</span>( <span class="cn">FALSE</span>){ <span class="co"># don&#39;t wanna run this!</span></span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a>  <span class="fu">library</span>( offartmb)</span>
<span id="cb38-3"><a href="#cb38-3" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" tabindex="-1"></a>  myobjfun <span class="ot">&lt;-</span> <span class="cf">function</span>( pars) <span class="fu">reclasso</span>( <span class="at">by=</span>pars, { <span class="co"># magic line</span></span>
<span id="cb38-5"><a href="#cb38-5" tabindex="-1"></a>      Ey <span class="ot">&lt;-</span> X <span class="sc">%%</span> pars</span>
<span id="cb38-6"><a href="#cb38-6" tabindex="-1"></a>      resid <span class="ot">&lt;-</span> y<span class="sc">-</span>Ey</span>
<span id="cb38-7"><a href="#cb38-7" tabindex="-1"></a>      <span class="fu">REPORTO</span>( Ey, resid) <span class="co"># two at once; could separate</span></span>
<span id="cb38-8"><a href="#cb38-8" tabindex="-1"></a>    <span class="fu">return</span>( <span class="fu">sum</span>( <span class="fu">sqr</span>( y<span class="sc">-</span>Ey)))</span>
<span id="cb38-9"><a href="#cb38-9" tabindex="-1"></a>    })</span>
<span id="cb38-10"><a href="#cb38-10" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">cbind</span>( <span class="dv">1</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) <span class="co"># regression</span></span>
<span id="cb38-12"><a href="#cb38-12" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="dv">5</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb38-13"><a href="#cb38-13" tabindex="-1"></a>  pp0 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span></span>
<span id="cb38-14"><a href="#cb38-14" tabindex="-1"></a></span>
<span id="cb38-15"><a href="#cb38-15" tabindex="-1"></a>  <span class="co"># Base-R</span></span>
<span id="cb38-16"><a href="#cb38-16" tabindex="-1"></a>  <span class="fu">myobjfun</span>( pp0)</span>
<span id="cb38-17"><a href="#cb38-17" tabindex="-1"></a>  <span class="fu">numvbderiv</span>( myobjfun, pp0) <span class="co"># numerical deriv (rough)</span></span>
<span id="cb38-18"><a href="#cb38-18" tabindex="-1"></a></span>
<span id="cb38-19"><a href="#cb38-19" tabindex="-1"></a>  <span class="co"># RTMB</span></span>
<span id="cb38-20"><a href="#cb38-20" tabindex="-1"></a>  ooo <span class="ot">&lt;-</span> RTMB<span class="sc">::</span><span class="fu">MakeADFun</span>( myobjfun, pp0)</span>
<span id="cb38-21"><a href="#cb38-21" tabindex="-1"></a>  ooo<span class="sc">$</span><span class="fu">fn</span>( pp0)</span>
<span id="cb38-22"><a href="#cb38-22" tabindex="-1"></a>  ooo<span class="sc">$</span><span class="fu">gr</span>( pp0)</span>
<span id="cb38-23"><a href="#cb38-23" tabindex="-1"></a>  <span class="co"># ... and they all lived happily ever after</span></span>
<span id="cb38-24"><a href="#cb38-24" tabindex="-1"></a>}</span></code></pre></div>
<p>As yet, I <em>haven’t</em> tested/implemented the following:</p>
<ul>
<li><p>several named parameter subsets (it’s all just one vector at
present, to be unpacked inside your function— coz that’s what
<code>optim/nlminb</code> expects of a base-R function);</p></li>
<li><p>random effects</p></li>
<li><p>there’s definitely no simulation or OSA capability yet.</p></li>
</ul>
</div>
<div class="footnotes footnotes-end-of-document">
<hr />
<ol>
<li id="fn1"><p>This deep-copy-on-subassignment seems to be unavoidable feature of
R for any non-base-class object, certainly in S3 and AFAIK also in
S4. Base-R arrays <em>can</em> do in-place modification, but there’s no
safe general way in your own code for your own classes, not even at
the C level. I doubt R-core has much interest in changing this,
although the word might has been bandied about for years. Packages
like <code>data.table</code> get round it only by defining new assignment
operators, which I didn’t want to do for humble <code>offarray</code> objects.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>Provided you stick to the rules. Are the rules documented? Not
really. Just stick to them anyway, is my advice.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>Nor <code>for/while/repeat/break/next</code>, but <code>if</code> is more significant
here.<a href="#fnref3" class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>While producing this example, I have started to think that the
error message should include <em>all</em> available variables (including
ones just calculated), not just the indices, because that might
clarify things a lot! Next version...<a href="#fnref4" class="footnote-back">↩︎</a></p></li>
<li id="fn5"><p>I might add a hack to make the loading-order irrelevant. I’ve done
such things before but it’s not trivial, so I might not get round to
it soon. Just load <code>offarray</code> first...<a href="#fnref5" class="footnote-back">↩︎</a></p></li>
</ol>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
